<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nanopub Creator Demo</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="./demo.css">
</head>
<body>
  <div class="demo-header">
    <h1>Nanopub Creator Demo</h1>
    <p>Create nanopublications from templates</p>
  </div>

  <div class="demo-container">
    <!-- Template Selection -->
    <div class="template-selection">
      <h2><i class="fas fa-layer-group"></i> Select or Load Template</h2>
      
      <!-- Custom Template URL Input -->
      <div class="custom-template-section">
        <label for="template-url-input">Or load from URL:</label>
        <div class="url-input-group">
          <input 
            type="url" 
            id="template-url-input" 
            placeholder="https://w3id.org/np/RA..." 
            class="template-url-input"
          />
          <button id="load-template-btn" class="btn-load">
            <i class="fas fa-download"></i> Load
          </button>
        </div>
      </div>

      <p>Or choose from examples:</p>
      <div class="template-grid" id="template-grid"></div>
    </div>

    <!-- Creator Form -->
    <div id="creator-container">
      <div class="empty-state">
        <h3>Select a Template to Begin</h3>
        <p>Click on any template card above or enter a template URL</p>
      </div>
    </div>

    <!-- Output Section -->
    <div class="output-section" id="output-section" style="display: none;">
      <h2><i class="fas fa-code"></i> Generated Nanopublication</h2>
      <div class="output-content empty" id="output-content">
        Submit the form to see the generated nanopublication here...
      </div>
      <div class="output-actions" style="display: none;" id="output-actions">
        <button class="btn-copy" onclick="copyOutput()">
          <i class="fas fa-copy"></i> Copy
        </button>
        <button class="btn-download" onclick="downloadOutput()">
          <i class="fas fa-download"></i> Download
        </button>
      </div>
    </div>

    <!-- Event Log -->
    <div class="event-log-section">
      <h2><i class="fas fa-bell"></i> Event Log</h2>
      <div class="event-log" id="event-log">
        <div class="event-log-item">
          <span class="event-time">--:--:--</span>
          <span class="event-type change">INFO</span>
          <span class="event-message">Demo initialized</span>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import NanopubCreator from '../src/index.js';
    import '../src/styles/creator.css';

    const templates = [
      {
        uri: 'https://w3id.org/np/RA24onqmqTMsraJ7ypYFOuckmNWpo4Zv5gsLqhXt7xYPU',
        name: 'Annotate a paper quotation',
        description: 'Annotating a paper quotation with personal interpretation',
        tags: ['citation', 'research']
      },
      {
        uri: 'https://w3id.org/np/RAX_4tWTyjFpO6nz63s14ucuejd64t2mK3IBlkwZ7jjLo',
        name: 'Declare Citation (CiTO)',
        description: 'Declare citations using Citation Typing Ontology',
        tags: ['citation', 'CiTO']
      },
      {
        uri: 'https://w3id.org/np/RAtoyEeCmsTWoUG2BsE7PxjabWTkYwRcoBSG1CPPNcwNk',
        name: 'Scholarly work metadata',
        description: 'Describe a scholarly work with detailed metadata',
        tags: ['metadata', 'publication']
      }
    ];

    let creator = null;
    let currentTrigContent = '';

    function initTemplateGrid() {
      const grid = document.getElementById('template-grid');
      
      templates.forEach(template => {
        const card = document.createElement('div');
        card.className = 'template-card';
        card.innerHTML = `
          <h3>${template.name}</h3>
          <p>${template.description}</p>
          <div class="template-tags">
            ${template.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
          </div>
        `;
        card.addEventListener('click', () => loadTemplate(template.uri));
        grid.appendChild(card);
      });
    }

    async function loadTemplate(uri) {
      logEvent('INFO', `Loading template: ${uri}`);
      const container = document.getElementById('creator-container');
      container.innerHTML = '<div class="loading">Loading template...</div>';

      try {
        if (creator) {
          creator.destroy?.();
        }

        creator = new NanopubCreator({
          publishServer: 'https://np.petapico.org/',
          validateOnChange: true,
          showHelp: true
        });

        creator.on('change', (data) => {
          logEvent('CHANGE', 'Form data updated');
        });

        creator.on('submit', ({ trigContent, formData }) => {
          logEvent('SUCCESS', 'Nanopublication generated');
          displayOutput(trigContent);
        });

        creator.on('error', ({ type, error }) => {
          logEvent('ERROR', `${type}: ${error.message}`);
        });

        await creator.renderFromTemplateUri(uri, container);
        logEvent('SUCCESS', 'Template loaded successfully');
      } catch (error) {
        logEvent('ERROR', `Failed to load template: ${error.message}`);
        container.innerHTML = `<div class="error-state"><p>Error: ${error.message}</p></div>`;
      }
    }

    function displayOutput(trigContent) {
      currentTrigContent = trigContent;
      const outputSection = document.getElementById('output-section');
      const outputContent = document.getElementById('output-content');
      const outputActions = document.getElementById('output-actions');

      outputSection.style.display = 'block';
      outputContent.classList.remove('empty');
      outputContent.textContent = trigContent;
      outputActions.style.display = 'flex';
    }

    function logEvent(type, message) {
      const log = document.getElementById('event-log');
      const time = new Date().toLocaleTimeString();
      const item = document.createElement('div');
      item.className = 'event-log-item';
      item.innerHTML = `
        <span class="event-time">${time}</span>
        <span class="event-type ${type.toLowerCase()}">${type}</span>
        <span class="event-message">${message}</span>
      `;
      log.insertBefore(item, log.firstChild);
    }

    window.copyOutput = function() {
      navigator.clipboard.writeText(currentTrigContent);
      logEvent('INFO', 'Copied to clipboard');
    };

    window.downloadOutput = function() {
      const blob = new Blob([currentTrigContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'nanopublication.trig';
      a.click();
      URL.revokeObjectURL(url);
      logEvent('INFO', 'Downloaded nanopublication');
    };

    // Custom URL loading
    document.getElementById('load-template-btn').addEventListener('click', () => {
      const input = document.getElementById('template-url-input');
      const url = input.value.trim();
      if (url) {
        loadTemplate(url);
      }
    });

    document.getElementById('template-url-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const url = e.target.value.trim();
        if (url) {
          loadTemplate(url);
        }
      }
    });

    initTemplateGrid();
  </script>
</body>
</html>
