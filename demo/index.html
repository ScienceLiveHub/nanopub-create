<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nanopub Creator Demo - Create Nanopublications from Templates</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="./demo.css">
</head>
<body>
  <div class="demo-header">
    <h1>üß¨ Nanopub Creator Demo</h1>
    <p>Create nanopublications from templates using the @sciencelivehub/nanopub-create library</p>
  </div>

  <div class="demo-container">
    <!-- Template Selection -->
    <div class="template-selection">
      <h2><i class="fas fa-layer-group"></i> Select a Template</h2>
      <p>Choose from popular nanopublication templates to get started:</p>
      
      <div class="template-grid" id="template-grid">
        <!-- Templates will be inserted here -->
      </div>
    </div>

    <!-- Creator Form -->
    <div id="creator-container">
      <div class="empty-state">
        <h3>Select a Template to Begin</h3>
        <p>Click on any template card above to load the form</p>
      </div>
    </div>

    <!-- Output Section -->
    <div class="output-section" id="output-section" style="display: none;">
      <h2><i class="fas fa-code"></i> Generated Nanopublication</h2>
      <div class="output-content empty" id="output-content">
        Submit the form to see the generated nanopublication here...
      </div>
      <div class="output-actions" style="display: none;" id="output-actions">
        <button class="btn-copy" onclick="copyOutput()">
          <i class="fas fa-copy"></i> Copy
        </button>
        <button class="btn-download" onclick="downloadOutput()">
          <i class="fas fa-download"></i> Download
        </button>
      </div>
    </div>

    <!-- Event Log -->
    <div class="event-log-section">
      <h2><i class="fas fa-bell"></i> Event Log</h2>
      <div class="event-log" id="event-log">
        <div class="event-log-item">
          <span class="event-time">--:--:--</span>
          <span class="event-type change">INFO</span>
          <span class="event-message">Demo initialized - select a template to begin</span>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import NanopubCreator from '../src/index.js';
    import '../src/styles/creator.css';

    // Available templates with metadata
    const templates = [
      {
        uri: 'https://w3id.org/np/RA24onqmqTMsraJ7ypYFOuckmNWpo4Zv5gsLqhXt7xYPU',
        name: 'Annotate a paper quotation',
        description: 'Annotating a paper quotation with personal interpretation',
        tags: ['citation', 'research']
      },
      {
        uri: ' https://w3id.org/np/RAX_4tWTyjFpO6nz63s14ucuejd64t2mK3IBlkwZ7jjLo',
        name: 'Declare Citation (CiTO)',
        description: 'Declare citations using Citation Typing Ontology',
        tags: ['citation', 'CiTO']
      },
      {
        uri: 'https://w3id.org/np/RAtoyEeCmsTWoUG2BsE7PxjabWTkYwRcoBSG1CPPNcwNk',
        name: 'Describing scholarly work at summary level - simple',
        description: 'Describe a scholarly work with detailed metadata',
        tags: ['metadata', 'publication']
      },
      {
        uri: 'https://w3id.org/np/RAKMzFc-2RgvSyrJy0BHfTFx0bEK5yENbnjJ5ElX9WSvc',
        name: 'Share Link',
        description: 'Share a useful link with the community',
        tags: ['sharing', 'resource']
      },
      {
        uri: 'http://purl.org/np/RAn0gvGnriPVVIes27pRmyCzVVQk5cKbjiQNu9phlpCjE',
        name: 'New Idea',
        description: 'Describe a new research idea or concept',
        tags: ['idea', 'concept']
      }
    ];

    let creator = null;
    let currentTrigContent = '';
    let selectedTemplate = null;

    // Initialize template grid
    function initTemplateGrid() {
      const grid = document.getElementById('template-grid');
      
      templates.forEach(template => {
        const card = document.createElement('div');
        card.className = 'template-card';
        card.onclick = () => selectTemplate(template);
        
        card.innerHTML = `
          <h3>${template.name}</h3>
          <p>${template.description}</p>
          <div class="template-tags">
            ${template.tags.map(tag => `<span class="template-tag">${tag}</span>`).join('')}
          </div>
        `;
        
        grid.appendChild(card);
      });
    }

    // Event logging
    function logEvent(type, message) {
      const timestamp = new Date().toLocaleTimeString();
      const logItem = document.createElement('div');
      logItem.className = 'event-log-item';
      
      logItem.innerHTML = `
        <span class="event-time">${timestamp}</span>
        <span class="event-type ${type}">${type.toUpperCase()}</span>
        <span class="event-message">${message}</span>
      `;
      
      const eventLog = document.getElementById('event-log');
      eventLog.insertBefore(logItem, eventLog.firstChild);
      
      // Keep only last 30 items
      while (eventLog.children.length > 30) {
        eventLog.removeChild(eventLog.lastChild);
      }
    }

    // Select template
    async function selectTemplate(template) {
      selectedTemplate = template;
      
      // Update UI
      document.querySelectorAll('.template-card').forEach(card => {
        card.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');
      
      logEvent('change', `Loading template: ${template.name}`);
      
      // Show loading state
      const container = document.getElementById('creator-container');
      container.innerHTML = `
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <p>Loading ${template.name} template...</p>
        </div>
      `;
      
      // Clean up previous creator
      if (creator) {
        creator.destroy();
      }

      // Create new instance
      creator = new NanopubCreator({
        publishServer: 'https://np.petapico.org/',
        theme: 'default',
        validateOnChange: true,
        showHelp: true
      });

      // Event listeners
      creator.on('change', (data) => {
        logEvent('change', `Form updated`);
      });

      creator.on('submit', async ({ trigContent, formData }) => {
        logEvent('submit', 'Nanopublication generated successfully');
        currentTrigContent = trigContent;
        
        // Show output
        const outputContent = document.getElementById('output-content');
        const outputSection = document.getElementById('output-section');
        const outputActions = document.getElementById('output-actions');
        
        outputContent.textContent = trigContent;
        outputContent.classList.remove('empty');
        outputSection.style.display = 'block';
        outputActions.style.display = 'flex';
      });

      creator.on('error', ({ type, error, errors }) => {
        logEvent('error', `Error (${type}): ${error?.message || errors?.join(', ')}`);
      });

      // Load template
      try {
        await creator.renderFromTemplateUri(template.uri, container);
        logEvent('change', `${template.name} template loaded and form rendered`);
      } catch (error) {
        logEvent('error', `Failed to load template: ${error.message}`);
        container.innerHTML = `
          <div class="empty-state">
            <h3>‚ùå Error Loading Template</h3>
            <p>${error.message}</p>
            <p>Please try another template or check your network connection.</p>
          </div>
        `;
      }
    }

    // Copy output
    window.copyOutput = function() {
      navigator.clipboard.writeText(currentTrigContent).then(() => {
        logEvent('change', 'Output copied to clipboard');
        const btn = document.querySelector('.btn-copy');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        setTimeout(() => {
          btn.innerHTML = originalText;
        }, 2000);
      });
    };

    // Download output
    window.downloadOutput = function() {
      const blob = new Blob([currentTrigContent], { type: 'application/trig' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `nanopub-${Date.now()}.trig`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      logEvent('change', 'Output downloaded as file');
    };

    // Initialize
    initTemplateGrid();
    logEvent('change', 'Demo ready - select a template to begin');
  </script>
</body>
</html>
